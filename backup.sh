#!/bin/bash

# ==================================================
# УНІВЕРСАЛЬНИЙ БЕКАП-СКРИПТ ДЛЯ РОЗРОБКИ (Rust, Python, JS тощо)
# Автор: Max Dev + Grok + GitHub Copilot
# Версія: 2.3 (03 січня 2026) — для новачків з повною шпаргалкою
# Запуск: ./backup.sh [--cleanup] [--dry-run] [--help]
# ОПИС: Завжди з кореню проекту (де лежить .git):
# ✅ Правильно
# cd проект && ./backup.sh
# ❌ Неправильно
# cd проект/crates/web && ./backup.sh  # ПОМИЛКА!
# ==================================================
#
# ПОКРОКОВЕ Пояснення, що робить скрипт (для джуна/нуба):
# 1. TIMESTAMP=$(date +"%Y%m%d_%H%M%S") — бере поточний час як ім'я папки.
# 2. BACKUP_DIR="backups/backup_$TIMESTAMP" — шлях до папки бекапу.
# 3. ORIGINAL_BRANCH=$(git rev-parse --abbrev-ref HEAD) — запам'ятовує твою гілку.
# 4. Перевірка git rev-parse --git-dir — чи це git-репо.
# 5. rsync — копіює файли з ігнором .gitignore/target/dist.
# 6. git checkout -b backup-$TIMESTAMP — створює нову гілку.
# 7. git add . && git commit — фіксує все в гілці.
# 8. git checkout $ORIGINAL_BRANCH — повертає тебе назад.
# 9. --cleanup видаляє старі бекапи (>7 днів).
# 10. --dry-run показує ЩО БУДЕ без реальних змін.
#
# ЧОМУ 2 БЕКАПИ? Файловий — якщо git зламався. Git-гілка — якщо файли пошкоджені.
# ==================================================

set -e  # Зупиняємо при помилці

TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="backups/backup_$TIMESTAMP"
ORIGINAL_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")

# Перевірки
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "❌ Це не git-репозиторій!"
    exit 1
fi

DRY_RUN=false
CLEANUP=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --cleanup) CLEANUP=true ;;
        --dry-run) DRY_RUN=true ;;
        --help) 
            cat << 'HELP'
╔════════════════════════════════════════════════════════════╗
║         🔧 УНІВЕРСАЛЬНИЙ БЕКАП-СКРИПТ — ДОВІДКА           ║
╚════════════════════════════════════════════════════════════╝

ВИКОРИСТАННЯ: ./backup.sh [опції]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 ОПЦІЇ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  (без опцій)   Звичайний бекап — найбезпечніше!
  
  --dry-run     Перевірити БЕЗ реальних змін (safe mode)
  
  --cleanup     Видалити бекапи старші 7 днів
  
  --help        Цей текст

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 ПРИКЛАДИ ЗАПУСКІВ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ./backup.sh
  → Створює бекап. Результат:
    ✅ Папка backups/backup_20260103_201500/
    ✅ Локальна git-гілка backup-20260103_201500
    ✅ Ти повертаєшся на свою гілку

  ./backup.sh --dry-run
  → Перевіряє БЕЗ змін. Результат:
    🩺 Показує що будет зроблено
    🩺 Нічого не створює (safe!)

  ./backup.sh --cleanup
  → Очищує старі бекапи. Результат:
    🧹 Видаляє backups/ старші 7 днів
    🧹 Новий бекап також створюється

  ./backup.sh --dry-run --cleanup
  → Перевіряє очистку БЕЗ змін

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📁 ЧТО БУВАЄ ПІСЛЯ БЕКАПУ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Файлові бекапи:
  $ ls -lah backups/
  → backups/backup_20260103_201500/
  → backups/backup_20260103_180000/
  → backups/backup_20260102_150000/

  Git бекап-гілки:
  $ git branch -a | grep backup-
  → backup-20260103_201500
  → backup-20260103_180000
  → backup-20260102_150000

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🆘 ЯК ВІДНОВИТИ (швидко):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  1. Подивитися бекапи:
     $ git branch -a | grep backup-

  2. Перейти на бекап:
     $ git checkout backup-20260103_201500

  3. Повернути один файл:
     $ git checkout backup-20260103_201500 -- src/main.rs

  4. Екстрене відновлення з файлового бекапу:
     $ cp -r backups/backup_20260103_201500/* .

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 ДЛЯ НОВАЧКІВ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  1. Перший раз:
     $ ./backup.sh --dry-run    # Переглянути
     $ ./backup.sh               # Справжній бекап

  2. Працюй спокійно:
     Робій свої зміни, не бійся щось зламати!

  3. Щось не те?
     $ git branch -a | grep backup-
     $ git checkout backup-...
     Готово! Все повернулось!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❓ ПИТАННЯ?
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Q: Бекап буде запушений на GitHub?
  A: НІ! Тільки локально. git push origin main 
     пошле тільки main, не бекап-гілки.

  Q: Можу видалити backups/?
  A: Можна, якщо є git-гілки (git branch -a | grep backup-)
     Файлові та git-бекапи незалежні!

  Q: Скільки бекапів зберігати?
  A: Скільки хочеш! ./backup.sh --cleanup видалить >7 днів

🎉 Готово! Запускай ./backup.sh прямо зараз!
HELP
            exit 0
            ;;
        *) echo "❌ Невідома опція: $1"; echo "Спробуй: ./backup.sh --help" ; exit 1 ;;
    esac
    shift
done

echo "🔄 Створюємо бекап від $TIMESTAMP (гілка: $ORIGINAL_BRANCH)"

# Файловий бекап (з .gitignore)
mkdir -p $BACKUP_DIR
if [ -f ".gitignore" ]; then
    if [ "$DRY_RUN" = true ]; then
        echo "🩺 Dry-run: rsync з .gitignore в $BACKUP_DIR"
    else
        rsync -a --exclude-from=.gitignore . "$BACKUP_DIR/" > /dev/null 2>&1 || true
        echo "✅ Файловий бекап: $BACKUP_DIR (з .gitignore)"
    fi
else
    if [ "$DRY_RUN" = true ]; then
        echo "🩺 Dry-run: rsync без .gitignore (виключає target, dist, backups)"
    else
        rsync -a --exclude='target' --exclude='dist' --exclude='backups' . "$BACKUP_DIR/" > /dev/null 2>&1 || true
        echo "✅ Файловий бекап: $BACKUP_DIR"
    fi
fi

# Git бекап-гілка
BACKUP_BRANCH="backup-$TIMESTAMP"
if git rev-parse --verify "$BACKUP_BRANCH" > /dev/null 2>&1; then
    echo "⚠️  Гілка $BACKUP_BRANCH вже існує — пропускаємо"
else
    if [ "$DRY_RUN" = true ]; then
        echo "🩺 Dry-run: створити гілку $BACKUP_BRANCH"
    else
        git checkout -b "$BACKUP_BRANCH" > /dev/null 2>&1 || { echo "❌ Помилка при створенні гілки"; exit 1; }
        git add . 2>/dev/null || true
        git commit -m "AUTO BACKUP: $TIMESTAMP" > /dev/null 2>&1 || echo "⚠️  Нічого комітити (вже чисто)"
        git checkout "$ORIGINAL_BRANCH" > /dev/null 2>&1 || { echo "❌ Помилка при повертанні на гілку"; exit 1; }
        echo "✅ Git бекап-гілка: $BACKUP_BRANCH"
    fi
fi

# Очищення старих бекапів
if [ "$CLEANUP" = true ] && [ "$DRY_RUN" = false ]; then
    echo "🧹 Видаляємо бекапи старші 7 днів..."
    find backups -mindepth 1 -maxdepth 1 -type d -name "backup_*" -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
    echo "✅ Очищено старі бекапи"
elif [ "$CLEANUP" = true ] && [ "$DRY_RUN" = true ]; then
    echo "🩺 Dry-run: видалити бекапи старші 7 днів"
fi

echo ""
echo "🎉 Бекап завершено!"
echo "📂 Файлові бекапи:  backups/"
echo "🌳 Git бекап-гілка: $BACKUP_BRANCH"
echo ""
echo "Поточний статус репозиторію:"
git status --short

# ================================================================================
# 📖 ДЕТАЛЬНА ШПАРГАЛКА ПО ВІДНОВЛЕННЮ (копіюй команди прямо звідси)
# ================================================================================

cat << 'EOF'

╔════════════════════════════════════════════════════════════════════════════╗
║           🔧 ШПАРГАЛКА: ЯК ВІДНОВИТИ ПРОЄКТ ІЗ БЕКАПУ                    ║
╚════════════════════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 КРОК 1: Знайти всі доступні бекапи
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Файлові бекапи (папки):
   $ ls -lah backups/
   
   Git бекап-гілки (локальні):
   $ git branch --list 'backup-*'
   
   Git бекап-гілки (всі, включаючи remote):
   $ git branch -a | grep backup-
   
   Приклад виводу:
   backup-20260103_201500
   backup-20260103_180000
   backup-20260102_150000

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📖 КРОК 2: Вибери стратегію відновлення (залежно від того, що пошкоджено)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🟢 ВАРІАНТ A: Повне відновлення з файлового бекапу (якщо git зламалось)
   ──────────────────────────────────────────────────────────────────────
   1. Остаток всіх змін локально:
   $ git reset --hard HEAD
   
   2. Скопіюй файли з бекапу:
   $ cp -r backups/backup_20260103_201500/* .
   
   3. Видали стару историю git (якщо потрібно):
   $ rm -rf .git && git init
   
   4. Закоміть відновлені файли:
   $ git add . && git commit -m "restore from backup 20260103_201500"

🟡 ВАРІАНТ B: Перейти на бекап-гілку і гляділи (якщо сумніваєшся)
   ──────────────────────────────────────────────────────────────────────
   1. Подивитися файли в бекапі БЕЗ змін:
   $ git show backup-20260103_201500:path/to/file.rs
   
   2. Або перейти на гілку (ВСІ файли змінятимуться):
   $ git checkout backup-20260103_201500
   
   3. Подивитися статус:
   $ git status
   
   4. Повернутися на свою гілку:
   $ git checkout main
   (або git checkout master, залежно від гілки)

🔵 ВАРІАНТ C: Частково відновити (один файл або папку)
   ──────────────────────────────────────────────────────────────────────
   1. Повернути один файл з бекапу:
   $ git checkout backup-20260103_201500 -- src/main.rs
   
   2. Або копіювати вручну з файлового бекапу:
   $ cp backups/backup_20260103_201500/src/main.rs src/
   
   3. Закомітити зміни:
   $ git add src/main.rs
   $ git commit -m "restore main.rs from backup"

🟣 ВАРІАНТ D: Злити весь бекап в поточну гілку (merge)
   ──────────────────────────────────────────────────────────────────────
   1. Переконайся, що ти на правильній гілці:
   $ git branch
   # * main
   
   2. Злий бекап-гілку:
   $ git merge backup-20260103_201500
   
   3. Якщо КОНФЛІКТИ — вирішуй вручну в редакторі, потім:
   $ git add .
   $ git commit -m "merge backup-20260103_201500"
   
   4. Якщо хочеш скасувати merge:
   $ git merge --abort

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🛡️  КРОК 3: Перевір історію комітів (щоб впевнитися в коректності)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Подивитися останні 10 комітів:
   $ git log --oneline -10
   
   З графіком (показує гілки):
   $ git log --oneline --graph -10
   
   Приклад виводу:
   * a1b2c3d (HEAD -> main) restore from backup
   * 9f8e7d6 AUTO BACKUP: 20260103_201500
   * 8c7d6e5 Initial MVP workspace
   
   Детальний формат (з датами):
   $ git log --oneline --pretty=format:"%h %s [%ar]" -10

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 КРОК 4: Пушь змінені на GitHub (коли все готово)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Пушь поточної гілки:
   $ git push origin main
   
   або (коротше, якщо HEAD вже мав tracking):
   $ git push
   
   Пушь бекап-гілки (якщо потрібна як історія):
   $ git push origin backup-20260103_201500
   
   Пушь ВСІ гілки з бекапами (обережно!):
   $ git push origin --all
   
   Перевір на GitHub (відкрий браузер):
   https://github.com/MaxDevStudio/rust-knowledge-platform/branches

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧹 КРОК 5: Очистити локальні бекапи (коли впевнений)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Видалити файловий бекап:
   $ rm -rf backups/backup_20260103_201500
   
   Видалити git бекап-гілку:
   $ git branch -D backup-20260103_201500
   
   Видалити ВСІ старих бекапів (>7 днів):
   $ ./backup.sh --cleanup
   
   Видалити бекап-гілку і з remote (GitHub):
   $ git push origin --delete backup-20260103_201500

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚡ ШВИДКА ДОВІДКА (копіюй ці команди прямо в терміналь)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Знайти бекап-гілку → перейти на неї → подивитися файли:
$ git branch -a | grep backup-
$ git checkout backup-20260103_201500
$ ls -la

Повернути один файл:
$ git checkout backup-20260103_201500 -- src/main.rs

Подивитися весь лог з гілками:
$ git log --graph --all --oneline

Скасувати останній коміт (якщо помилкою):
$ git reset --soft HEAD~1

Скасувати всі локальні зміни (ОБЕРЕЖНО!):
$ git reset --hard HEAD

Подивитися різницю між двома гілками:
$ git diff main backup-20260103_201500

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❓ ЧАСТО ЗАДАВАНІ ПИТАННЯ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Q: Бекап-гілка буде запушена з основною гілкою?
A: НІ! git push origin main пошле тільки main. Бекап-гілка залишається в локалі.
   Щоб запушити: git push origin backup-20260103_201500

Q: Можу я видалити папку backups/ без ризику?
A: Можна, якщо у тебе є git-гілки бекапів (git branch -a | grep backup-).
   Файлові бекапи і git-гілки — незалежні!

Q: Як відновити 2-3 дні назад?
A: git log --all --oneline | grep BACKUP
   Знайди час → git checkout backup-20260101_120000

Q: Я випадково видалив файл, як його відновити?
A: git checkout HEAD~1 -- path/to/deleted/file.rs
   або з бекапу: git checkout backup-... -- path/to/file.rs

Q: Що робити при MERGE CONFLICT?
A: 1. git status (подивись які файли в конфлікті)
   2. Відкрий файл в редакторі — буде <<<<< ===== >>>>>
   3. Видали маркери конфлікту, залиш те що потрібно
   4. git add файл && git commit

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 Пам'ятай: З цим скриптом ти завжди можеш повернути 
  будь-який час розвитку за кілька команд!

EOF